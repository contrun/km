<!doctype html><html><title>Chrome download shelf - wiki</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name=apple-mobile-web-app-capable content="yes"><meta name=description content="Chrome download shelf is the widget shown in the buttom when you initiate a new download. This document summarizes how the download shelf is implemented. It is sketchy on the details. For more information, click on the source code or documentation links.
How to inspect chrome browser ui components In short, run chrome with chromium --enable-ui-devtools=1234 and open url chrome://inspect/#native-ui. See also UI DevTools Overview and Chromium Desktop UI Debugging Tools and Tips."><link rel=stylesheet href=https://wiki.cont.run/css/main.min.9876f229ece74a87e784cb6ac19f558d58f7c34e91d316c290e35437ca00d7d6.css><body><header><a href=../ id=logo><svg id="Capa_1" enable-background="new 0 0 511.992 511.992" height="512" viewBox="0 0 511.992 511.992" width="512" xmlns="http://www.w3.org/2000/svg"><g><g><g><path d="m256 420.826c0 38.345-11.844 68.545-49.991 68.014-27.744-.385-51.481-15.31-61.853-39.46-1.239-2.887-4.024-4.734-7.154-4.725-.07.0-.135.0-.201.0-47.474.0-75.537-26.171-75.537-73.882.0-5.633.542-11.138 1.568-16.468.62-3.229-.825-6.489-3.671-8.125C23.668 325.748 10 300.053 10 255.997c0-44.057 13.668-69.757 49.161-90.185 2.846-1.636 4.291-4.896 3.671-8.13-1.026-5.33-1.568-10.83-1.568-16.463.0-47.711 28.064-73.882 75.537-73.882h.201c3.13.009 5.915-1.837 7.154-4.729 10.372-24.145 34.109-39.069 61.853-39.455C244.159 22.621 256 52.821 256 91.166" fill="#ff9eb1"/></g><g><g><g><path d="m256 91.166c0-38.344 11.844-68.545 49.991-68.014 27.744.385 51.481 15.31 61.853 39.46 1.239 2.887 4.024 4.734 7.154 4.724h.201c47.474.0 75.537 26.171 75.537 73.882.0 5.633-.542 11.138-1.568 16.468-.62 3.229.825 6.489 3.671 8.125C488.332 186.245 502 211.939 502 255.996s-13.668 69.756-49.161 90.185c-2.846 1.636-4.291 4.896-3.671 8.13 1.026 5.33 1.568 10.83 1.568 16.463.0 47.711-28.064 73.882-75.537 73.882h-.201c-3.13-.009-5.915 1.837-7.154 4.729-10.372 24.145-34.109 39.069-61.853 39.455-38.15.531-49.991-29.669-49.991-68.014" fill="#ff7d97"/></g></g><g><g><path d="m502 265.996c-4.193.0-7.984-2.713-9.407-6.636-1.419-3.912-.16-8.459 3.063-11.092 3.291-2.689 8.009-2.99 11.621-.758 3.568 2.205 5.404 6.578 4.478 10.669-1.02 4.501-5.126 7.817-9.755 7.817z"/></g></g></g><g><path d="m340.83 229.18h-58.013v-58.014h-53.634v58.014H171.17v53.633h58.013v58.013h53.634v-58.013h58.013z" fill="#faf7f5"/></g></g><g><g><path d="m498.468 291.859c-5.141-2.02-10.945.508-12.965 5.648-6.442 16.389-18.055 28.727-37.649 40.005-6.513 3.746-9.932 11.253-8.505 18.689.921 4.783 1.388 9.686 1.388 14.572.0 41.792-22.662 63.882-65.537 63.882h-.225c-.938.0-1.864.074-2.771.217-15.031-4.92-23.796-20.93-19.661-36.479 1.42-5.337-1.757-10.815-7.094-12.234-5.333-1.418-10.814 1.756-12.234 7.094-5.958 22.405 4.241 45.396 23.384 56.443-9.583 17.791-28.602 28.836-50.748 29.145-11.303.146-19.802-2.743-26.011-8.867-9.184-9.057-13.84-25.592-13.84-49.148v-70h16.816c5.522.0 10-4.477 10-10v-48.014h48.014c5.522.0 10-4.477 10-10V229.18c0-5.523-4.478-10-10-10h-48.014v-48.014c0-5.523-4.478-10-10-10H266v-70c0-23.555 4.657-40.09 13.841-49.148 6.21-6.123 14.696-9.022 26.011-8.867 23.862.332 44.096 13.132 52.803 33.405.218.509.458 1.003.719 1.483-3.225 8.243-9.084 15.093-16.833 19.574-8.993 5.2-19.465 6.581-29.485 3.89-5.337-1.434-10.819 1.73-12.251 7.064-1.433 5.334 1.729 10.819 7.063 12.252 5.074 1.363 10.221 2.037 15.338 2.037 10.2.0 20.272-2.681 29.346-7.928 11.083-6.408 19.607-16.017 24.616-27.575 41.6.67 63.569 22.718 63.569 63.866.0 4.89-.467 9.794-1.389 14.582-1.427 7.426 1.991 14.933 8.502 18.678 19.572 11.267 31.176 23.584 37.625 39.936 1.552 3.934 5.318 6.334 9.306 6.333 1.221.0 2.462-.225 3.666-.7 5.138-2.026 7.66-7.834 5.634-12.972-7.943-20.141-22.201-35.773-44.801-49.086.967-5.521 1.457-11.155 1.457-16.772.0-52.114-31.48-83.391-84.288-83.876-12.157-26.863-38.963-43.753-70.318-44.189-16.67-.232-30.255 4.688-40.332 14.625-3.813 3.76-7.08 8.226-9.797 13.382-2.717-5.156-5.984-9.622-9.797-13.382-10.075-9.937-23.668-14.852-40.333-14.625-31.353.437-58.158 17.325-70.32 44.189-52.807.485-84.286 31.762-84.286 83.876.0 5.617.49 11.253 1.458 16.771-37.422 22.031-52.724 50.552-52.724 98.008.0 47.451 15.299 75.969 52.721 98.006-.967 5.521-1.457 11.154-1.457 16.772.0 52.114 31.48 83.391 84.288 83.876 12.157 26.863 38.963 43.753 70.318 44.189.377.005.751.008 1.125.008 16.172.0 29.358-4.92 39.207-14.632 3.813-3.76 7.08-8.226 9.797-13.382 2.717 5.156 5.984 9.622 9.797 13.382 9.849 9.713 23.034 14.633 39.208 14.632.373.0.749-.003 1.125-.008 31.352-.436 58.158-17.325 70.32-44.189 52.807-.485 84.286-31.762 84.286-83.876.0-5.617-.49-11.253-1.458-16.772 22.634-13.329 36.901-28.989 44.838-49.178 2.022-5.14-.507-10.945-5.647-12.966zM282.816 239.18h48.014v33.633h-48.014c-5.522.0-10 4.477-10 10v48.014h-33.633v-48.014c0-5.523-4.477-10-10-10H181.17V239.18h48.014c5.523.0 10-4.477 10-10v-48.014h33.633v48.014c-.001 5.523 4.477 10 9.999 10zm-50.657 230.794c-6.21 6.124-14.717 9.018-26.011 8.867-23.862-.331-44.096-13.132-52.803-33.405-.218-.509-.458-1.003-.719-1.483 3.225-8.243 9.085-15.093 16.833-19.574 8.992-5.2 19.463-6.581 29.485-3.89 5.337 1.434 10.819-1.73 12.251-7.064 1.433-5.333-1.73-10.819-7.064-12.251-15.188-4.08-31.059-1.988-44.684 5.891-11.083 6.408-19.607 16.017-24.616 27.575-41.6-.67-63.569-22.718-63.569-63.866.0-4.89.467-9.794 1.389-14.582 1.427-7.427-1.991-14.934-8.502-18.678-32.183-18.528-44.149-40.621-44.149-81.517.0-40.9 11.966-62.994 44.146-81.517 6.513-3.746 9.932-11.253 8.505-18.689-.921-4.783-1.388-9.686-1.388-14.572.0-41.792 22.662-63.882 65.537-63.882h.225c.938.0 1.864-.074 2.771-.217 15.031 4.92 23.796 20.93 19.661 36.479-1.42 5.337 1.757 10.815 7.094 12.234.861.229 1.726.338 2.577.338 4.422.0 8.467-2.956 9.657-7.432 5.958-22.405-4.241-45.396-23.384-56.443 9.583-17.791 28.602-28.836 50.748-29.145 11.267-.15 19.801 2.743 26.011 8.867 9.184 9.057 13.84 25.592 13.84 49.148v70h-16.816c-5.522.0-10 4.477-10 10v48.014H171.17c-5.522.0-10 4.477-10 10v53.633c0 5.523 4.478 10 10 10h48.014v48.014c0 5.523 4.478 10 10 10H246v70c0 23.554-4.657 40.09-13.841 49.147z"/><path d="m139.699 228.227c-6.766.0-13.186 1.514-18.907 4.31-3.049-8.65-8.286-16.485-15.336-22.673-4.151-3.643-10.469-3.233-14.113.918-3.643 4.15-3.232 10.469.918 14.112 6.711 5.891 10.816 14.143 11.498 22.953-1.213 1.914-2.293 3.946-3.225 6.088-1.145 2.633-2.015 5.316-2.615 8.019-13.414 11.422-33.601 10.834-46.225-1.792-3.906-3.904-10.236-3.904-14.143.0-3.905 3.905-3.905 10.237.0 14.143 10.524 10.524 24.354 15.784 38.193 15.784 8.04.0 16.083-1.775 23.484-5.325 1.904 5.443 4.967 10.557 9.136 15.03.596.639 1.204 1.269 1.826 1.891 1.953 1.953 4.512 2.929 7.071 2.929 2.56.0 5.118-.976 7.071-2.929 3.905-3.905 3.905-10.237.0-14.143-.458-.458-.906-.922-1.342-1.389-6.26-6.716-7.799-15.778-4.118-24.241 2.878-6.616 9.86-13.686 20.826-13.686 5.522.0 10-4.477 10-10 .001-5.522-4.476-9.999-9.999-9.999z"/><path d="m387.667 287.543c-3.905 3.905-3.905 10.237.0 14.143 1.953 1.953 4.512 2.929 7.071 2.929s5.118-.976 7.071-2.929c.622-.622 1.23-1.253 1.83-1.896 4.167-4.471 7.229-9.583 9.133-15.025 7.401 3.549 15.444 5.324 23.484 5.324 13.839.0 27.67-5.261 38.193-15.784 3.905-3.905 3.905-10.237.0-14.143-3.906-3.904-10.236-3.904-14.143.0-12.624 12.625-32.811 13.214-46.225 1.792-.6-2.702-1.47-5.386-2.615-8.019-.932-2.142-2.012-4.175-3.225-6.088.682-8.81 4.787-17.062 11.498-22.953 4.15-3.644 4.561-9.962.918-14.112-3.646-4.151-9.964-4.563-14.113-.918-7.05 6.189-12.287 14.023-15.336 22.673-5.721-2.796-12.141-4.31-18.907-4.31-5.523.0-10 4.477-10 10s4.477 10 10 10c10.966.0 17.948 7.07 20.826 13.686 3.681 8.463 2.142 17.525-4.114 24.237-.44.47-.888.935-1.346 1.393z"/></g></g></g></svg></a><h3 class=site-title>wiki</h3></header><div class=grid-container><div class=grid><div class=page data-level=1><div class=content><h1>Chrome download shelf</h1><p>Chrome download shelf is the widget shown in the buttom when you initiate a new download. This document summarizes how the download shelf is implemented.
It is sketchy on the details. For more information, click on the source code or documentation links.</p><h2 id=how-to-inspect-chrome-browser-ui-components>How to inspect chrome browser ui components</h2><p>In short, run chrome with <code>chromium --enable-ui-devtools=1234</code> and open url <code>chrome://inspect/#native-ui</code>.
See also <a href=https://chromium.googlesource.com/chromium/src.git/+/refs/heads/main/docs/ui/ui%5Fdevtools/index.md>UI DevTools Overview</a> and <a href=https://chromium.googlesource.com/chromium/src.git/+/refs/heads/main/docs/ui/learn/ui%5Fdebugging.md>Chromium Desktop UI Debugging Tools and Tips</a>.</p><h2 id=layout-in-browser-window>Layout in browser window</h2><h3 id=how-to-layout-a-new-component>How to layout a new component</h3><p>The elements of chromium UI are <a href=https://chromium.googlesource.com/chromium/src.git/+/refs/heads/main/docs/ui/views/overview.md>views</a>. A View is a UI element, similar to an HTML DOM element. In order to create new UI componenets, we need to create corresponding views.
Take download shelf as an example, the entrypoint to register new browser views is <code>browser_view_layout.cc</code>.
<a href=https://github.com/chromium/chromium/blob/cee4f7f8dbd430f896107825de7b7e52793b9027/chrome/browser/ui/views/frame/browser%5Fview%5Flayout.cc#L643-652>Here</a> is how chromium layout download shelf in the main window, where the <code>download_shelf_</code> is a view created <a href=https://github.com/chromium/chromium/blob/5ab57336e2ba9f31d068fafbba236ba3ecf94519/chrome/browser/ui/views/frame/browser%5Fview.cc#L1992-2004>here</a>.</p><h2 id=download-shelf>Download shelf</h2><h3 id=implementations>Implementations</h3><p>There are currently two implementations for the download shelf. <a href=https://github.com/chromium/chromium/blob/de2dbd2f021b363033309eb740dad3f84dd9d47c/chrome/browser/ui/views/download/download%5Fshelf%5Fview.cc>One</a> is implemented in c++ with MVC architecture, while <a href=https://github.com/chromium/chromium/blob/bddb2627588da1698987a67bd503d1766962dc2c/chrome/browser/ui/views/download/download%5Fshelf%5Fweb%5Fview.cc>the other</a> is implemented with <a href=https://chromium.googlesource.com/chromium/src/+/HEAD/docs/webui%5Fexplainer.md>webui</a> using web technologies.</p><h3 id=mvc-architecture>MVC Architecture</h3><p>Chromium uses the well-known MVC design pattern to layout UI components, although sometimes model, view and controller are not strictly separated.</p><p>Here is a diagram which illustrates how mvc architecture works.</p><figure><img src=assets/images/mvc.webp></figure><p>The download shelf view is the UI that is visiable to the user. The user may interact with the download shelf, which then leverages the controller functions to update the download items.</p><p>For example, when the user click on the context menu (shown by <a href=https://github.com/chromium/chromium/blob/bddb2627588da1698987a67bd503d1766962dc2c/chrome/browser/ui/views/download/download%5Fshelf%5Fweb%5Fview.cc#L144-158><code>DownloadShelfWebView::ShowDownloadContextMenu</code></a>) of a download item on the download shelf. The download shelf view executes this download command by
calling <a href=https://github.com/chromium/chromium/blob/bddb2627588da1698987a67bd503d1766962dc2c/chrome/browser/download/download%5Fcommands.cc#L161-166><code>DownloadCommands::ExecuteCommand</code></a>, which in turn calls <a href=https://github.com/chromium/chromium/blob/bbf9b18a210bdc2e678d6fa83d52c8ce4de2b46b/chrome/browser/download/download%5Fui%5Fmodel.cc#L599-654>DownloadUIModel::ExecuteCommand</a> of the <code>DownloadUIModel</code>.</p><p>When the download items are modified, the views may be updated according by the controllers. The download item models notify controller for updates using the observer design pattern.</p><p>For example, <a href=https://github.com/chromium/chromium/blob/ff9ee2b6257ea513db88fe9fe2a4f6263908d197/chrome/browser/download/download%5Fui%5Fcontroller.h#L18-54><code>DownloadUIController</code></a> <a href=https://en.wikipedia.org/wiki/Observer%5Fpattern>observes</a> download item modifications, the notifications are sent by the download manager core services (<code>DownloadNotificationManager</code>).
When a new download item is ready, download core service calls <a href=https://github.com/chromium/chromium/blob/b6ddfbc505103f71848bc463dd5c598f5b332f86/chrome/browser/download/notification/download%5Fnotification%5Fmanager.cc#L22-41><code>DownloadNotificationManager::OnNewDownloadReady</code></a>, which then calls <a href=https://github.com/chromium/chromium/blob/08e7ed8fb282e0857ac74d9c01f449be3754385b/chrome/browser/download/download%5Fui%5Fcontroller.cc#L79-109><code>DownloadShelfUIControllerDelegate::OnNewDownloadReady</code></a>, which in turn
calls <code>browser->window()->GetDownloadShelf()->AddDownload(std::move(model))</code> to make the download item show up on the download shelf.</p><h3 id=download-items>Download items</h3><p>There are three data models for the download items.</p><h4 id=download-ui-model>Download UI model</h4><p><a href=https://github.com/chromium/chromium/blob/bbf9b18a210bdc2e678d6fa83d52c8ce4de2b46b/chrome/browser/download/download%5Fui%5Fmodel.h><code>DownloadUIModel</code></a> is an interface to define methods to operate on download items (e.g. pasue, resume downloads), show download item status (e.g. saved file name, downloading status).</p><h4 id=download-item-model>Download item model</h4><p><a href=https://github.com/chromium/chromium/blob/7c64c7c7941e92a0569b62afca196fd331c131cd/chrome/browser/download/download%5Fitem%5Fmodel.h#L24><code>DownloadItemModel</code></a> is just a <a href=https://github.com/chromium/chromium/blob/7c64c7c7941e92a0569b62afca196fd331c131cd/chrome/browser/download/download%5Fitem%5Fmodel.h#L27>wrapper</a> around <a href=https://github.com/chromium/chromium/blob/7055d591db3f3aa416c0db825ab49c8b281866d0/components/download/public/common/download%5Fitem.h><code>download::DownloadItem</code></a>, which implements the download UI model interface.</p><h4 id=download-item>Download item</h4><p><a href=https://github.com/chromium/chromium/blob/7055d591db3f3aa416c0db825ab49c8b281866d0/components/download/public/common/download%5Fitem.h><code>download::DownloadItem</code></a> is the underlying download item implementation. It defines what represents a download item, how to serialize download items, how to store their states, etc.</p><h4 id=menu-and-commands>Menu and commands</h4><p>To show a simple context menu, we need to inherit <a href=https://github.com/chromium/chromium/blob/2b2b679ab421f84f6e1fdc671772029e66acbfc8/ui/base/models/simple%5Fmenu%5Fmodel.h#L32-75><code>ui::SimpleMenuModel::Delegate</code></a>. A <code>SimpleMenuModel::Delegate</code> subclass needs to define some commands and their actions.
Commands correspond to menu items. When a menu item is clicked, the corresponding action is executed.</p><h2 id=webui-download-shelf>Webui download shelf</h2><p>“WebUI” is a term used to loosely describe parts of Chrome&rsquo;s UI implemented with web technologies (i.e. HTML, CSS, JavaScript).</p><h3 id=communication-between-the-browser-and-webui-web-page>Communication Between the Browser and WebUI web page</h3><p>Bi-direction communication by <a href=https://chromium.googlesource.com/chromium/src/+/HEAD/mojo/README.md>mojo</a> (a high level IPC abstraction).</p><h4 id=data-definition-and-rpc>Data definition and RPC</h4><p>The data structures and rpc interfaces are defined in <a href=https://github.com/chromium/chromium/blob/2aa264c2b51a5ff4856a6afbf2b640aa4d452491/chrome/browser/ui/webui/download%5Fshelf/download%5Fshelf.mojom><code>download_shelf.mojom</code></a>. It contains what structures represent a download when passing from browser to webpage, and vice versa, and what remote procedure calling does the browser provide.
Note that the download items defined here is different from <a href=https://github.com/chromium/chromium/blob/7055d591db3f3aa416c0db825ab49c8b281866d0/components/download/public/common/download%5Fitem.h><code>download::DownloadItem</code></a>. We may need to convert from one to another.</p><h4 id=browser-side-handler>Browser side handler</h4><p>Browser side handlers are normally called <code>PageHandler</code>. The download shelf <code>PageHandler</code> defines methods to accept rpc request from the website, execute the relevant methods, and return the results.
Examples are opening the downloaded item, removing a download. The interface is <a href=https://github.com/chromium/chromium/blob/2aa264c2b51a5ff4856a6afbf2b640aa4d452491/chrome/browser/ui/webui/download%5Fshelf/download%5Fshelf.mojom#L196-222>here</a>. It is implemented <a href=https://github.com/chromium/chromium/blob/bddb2627588da1698987a67bd503d1766962dc2c/chrome/browser/ui/webui/download%5Fshelf/download%5Fshelf%5Fui.cc>here</a> in the browser. The method calls are delegated to the underlying download models.
The webui client calls these methods by the generated mojo apis.</p><h4 id=web-page-side-handler>Web page side handler</h4><p>Web page side handlers are normally called <code>Handler</code>. They are used by the web page to handled native RPC requests from the browser. When the browser did something, it may want to notify the browser for its effects,
e.g. there is a new download, the webui may want to show it on its interface. <a href=https://github.com/chromium/chromium/blob/2aa264c2b51a5ff4856a6afbf2b640aa4d452491/chrome/browser/ui/webui/download%5Fshelf/download%5Fshelf.mojom#L224-238>Here</a> are the download shelf web page handlers. There are implmented in javascript <a href=https://github.com/chromium/chromium/blob/c78ebea75e7997ae4251dd1b633069f4d56d2bab/chrome/browser/resources/download%5Fshelf/download%5Flist.ts>here</a>.</p><h3 id=ui-embedding>UI embedding</h3><p>The webui have low barriers to entry, but it may lack some desirable effects. For example, we may need to show a native menu. We need to define a UI embedder to show native context menu.
The download shelf define a <code>DownloadShelfUIEmbedder</code> <a href=https://github.com/chromium/chromium/blob/6d25ca3911cab6c97ea862ab04432fa7f65fa810/chrome/browser/ui/webui/download%5Fshelf/download%5Fshelf%5Fui%5Fembedder.h>here</a>. When the user right clicks on a download item, he actually sees the context menu of the <a href=https://github.com/chromium/chromium/blob/6d25ca3911cab6c97ea862ab04432fa7f65fa810/chrome/browser/ui/views/download/download%5Fshelf%5Fweb%5Fview.h#L71><code>DownloadShelfContextMenuView</code></a> which is able to display native context menu.</p><h3 id=webui-registration>WebUI registration</h3><p>To register a <code>chrome://</code> url for a webui, we need to register it in the <code>GetWebUIFactoryFunction</code>. <a href=https://github.com/chromium/chromium/blob/a19d59a885991f5b8be03bbc37926410e307299a/chrome/browser/ui/webui/chrome%5Fweb%5Fui%5Fcontroller%5Ffactory.cc#L679-681>Here</a> is how download shelf is registered.</p></div></div></div></div><script src=https://wiki.cont.run/js/URI.js type=text/javascript></script><script src=https://wiki.cont.run/js/page.js type=text/javascript></script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></body></html>